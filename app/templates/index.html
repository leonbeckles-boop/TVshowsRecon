<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TV Recs – Mini UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-semibold">TV Recommender – Mini UI</h1>
      <button id="btnIngest" class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">
        Ingest Reddit (15)
      </button>
    </header>

    <!-- Search -->
    <section class="bg-white rounded-2xl p-4 shadow-sm">
      <div class="flex gap-3 items-end">
        <div class="flex-1">
          <label class="block text-sm text-slate-600 mb-1" for="q">Search shows</label>
          <input id="q" type="text" placeholder="e.g. the, break, office…" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-400" />
        </div>
        <button id="btnSearch" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">Search</button>
      </div>
      <p id="searchHint" class="text-xs text-slate-500 mt-2">Tip: results come from your DB; use “Ingest Reddit” if you’ve got no shows yet.</p>
      <div id="searchResults" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>

    <!-- Posts for selected show -->
    <section class="bg-white rounded-2xl p-4 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 id="postsTitle" class="text-lg font-medium">Reddit posts</h2>
        <div class="text-xs text-slate-500" id="postsCount"></div>
      </div>
      <div id="postsList" class="mt-3 space-y-3"></div>
    </section>

    <!-- Library quick actions (user 1) -->
    <section class="bg-white rounded-2xl p-4 shadow-sm">
      <h2 class="text-lg font-medium">Your Library (User #1)</h2>
      <div class="flex gap-2 mt-2">
        <input id="favTmdb" type="number" placeholder="TMDB id (e.g. 1396)" class="rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-400" />
        <button id="btnAddFav" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-500">Add Favorite</button>

        <input id="rateTmdb" type="number" placeholder="TMDB id" class="rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-400" />
        <input id="rateScore" type="number" step="0.1" min="0" max="10" placeholder="Rating 0–10" class="rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-400 w-32" />
        <button id="btnRate" class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500">Rate</button>

        <button id="btnListFavs" class="ml-auto px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">List Favorites</button>
      </div>
      <div id="libraryOutput" class="mt-3 text-sm text-slate-700"></div>
    </section>

    <footer class="text-center text-xs text-slate-400">
      Built with FastAPI · Tailwind · plain fetch
    </footer>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const $list = (s) => document.querySelectorAll(s);

    async function apiGet(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function apiPost(url, body) {
      const r = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function showToast(msg, good=true) {
      const el = document.createElement("div");
      el.className = "fixed bottom-4 right-4 px-3 py-2 rounded-xl text-white " + (good ? "bg-emerald-600" : "bg-rose-600");
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2200);
    }

    function renderShows(items) {
      const root = $("#searchResults");
      root.innerHTML = "";
      if (!items || !items.length) {
        root.innerHTML = `<div class="text-sm text-slate-500">No shows found. Try Ingest first or a broader query.</div>`;
        return;
      }
      for (const s of items) {
        const card = document.createElement("div");
        card.className = "rounded-xl border border-slate-200 p-3 flex gap-3";
        card.innerHTML = `
          <img src="${s.poster_url ?? ""}" class="w-16 h-24 object-cover rounded-lg bg-slate-100" onerror="this.style.display='none'"/>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">${s.title}</h3>
              <span class="text-xs text-slate-500">${s.year ?? ""}</span>
            </div>
            <div class="mt-2 flex gap-2">
              <button class="btnPosts px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm" data-show="${s.show_id}">View posts</button>
              ${s.external_id ? `<button class="btnFav px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm" data-tmdb="${s.external_id}">+ Favorite</button>` : ""}
            </div>
          </div>
        `;
        root.appendChild(card);
      }
      $list(".btnPosts").forEach(btn => btn.addEventListener("click", async (e) => {
        const showId = e.target.dataset.show;
        await loadPosts(showId);
      }));
      $list(".btnFav").forEach(btn => btn.addEventListener("click", async (e) => {
        const tmdbId = Number(e.target.dataset.tmdb);
        try {
          await apiPost("/library/1/favorites", { tmdb_id: tmdbId });
          showToast("Added to favorites");
        } catch (err) {
          showToast("Favorite failed", false);
          console.error(err);
        }
      }));
    }

    async function loadPosts(showId) {
      $("#postsTitle").textContent = `Reddit posts — show #${showId}`;
      try {
        const items = await apiGet(`/shows/${showId}/posts?limit=50`);
        $("#postsCount").textContent = `${items.length} posts`;
        const root = $("#postsList");
        root.innerHTML = "";
        if (!items.length) {
          root.innerHTML = `<div class="text-sm text-slate-500">No posts yet.</div>`;
          return;
        }
        for (const p of items) {
          const a = document.createElement("a");
          a.className = "block p-3 rounded-xl border border-slate-200 hover:bg-slate-50";
          a.href = p.url ?? "#";
          a.target = "_blank";
          a.rel = "noopener";
          a.innerHTML = `
            <div class="text-sm text-slate-500">${p.subreddit}</div>
            <div class="font-medium">${p.title}</div>
            <div class="text-xs text-slate-500 mt-1">score ${p.score} · ${p.num_comments} comments</div>
          `;
          $("#postsList").appendChild(a);
        }
      } catch (err) {
        $("#postsList").innerHTML = `<div class="text-sm text-rose-600">Failed to load posts.</div>`;
        console.error(err);
      }
    }

    // Actions
    $("#btnSearch").addEventListener("click", async () => {
      const q = $("#q").value.trim();
      const items = await apiGet(`/shows?q=${encodeURIComponent(q)}`);
      renderShows(items);
    });

    $("#btnIngest").addEventListener("click", async () => {
      $("#btnIngest").disabled = true;
      try {
        const res = await apiPost("/ingest/reddit?limit=15", {});
        showToast(`Ingest ok: ${res.saved} new, ${res.updated} updated`);
      } catch (err) {
        showToast("Ingest failed", false);
        console.error(err);
      } finally {
        $("#btnIngest").disabled = false;
      }
    });

    $("#btnAddFav").addEventListener("click", async () => {
      const tmdb = Number($("#favTmdb").value);
      if (!tmdb) return showToast("Enter a TMDB id", false);
      try {
        await apiPost("/library/1/favorites", { tmdb_id: tmdb });
        showToast("Added to favorites");
      } catch (err) {
        showToast("Favorite failed", false);
        console.error(err);
      }
    });

    $("#btnListFavs").addEventListener("click", async () => {
      try {
        const favs = await apiGet("/library/1/favorites");
        $("#libraryOutput").textContent = JSON.stringify(favs, null, 2);
      } catch (err) {
        $("#libraryOutput").textContent = "Failed to fetch favorites.";
        console.error(err);
      }
    });

    $("#btnRate").addEventListener("click", async () => {
      const tmdb = Number($("#rateTmdb").value);
      const rating = Number($("#rateScore").value);
      if (!tmdb || isNaN(rating)) return showToast("Enter TMDB id & rating", false);
      try {
        await apiPost("/library/1/ratings", { tmdb_id: tmdb, rating });
        showToast("Rating saved");
      } catch (err) {
        showToast("Rating failed", false);
        console.error(err);
      }
    });

    // Initial hint results
    (async () => {
      try {
        const items = await apiGet("/shows?q=the");
        renderShows(items);
      } catch {}
    })();
  </script>
</body>
</html>

<div class="mt-4 bg-white rounded-2xl p-4 shadow-sm">
  <h2 class="text-lg font-medium">Recommendations</h2>
  <div class="flex items-end gap-2 mt-2">
    <input id="recUser" type="number" value="1" class="rounded-xl border-slate-300 w-24" />
    <input id="recTopN" type="number" value="10" class="rounded-xl border-slate-300 w-20" />
    <button id="btnRecs" class="px-3 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-500">Get Recs</button>
  </div>
  <div id="recsOutput" class="mt-3 grid gap-3"></div>
</div>
<script>
  document.getElementById("btnRecs").addEventListener("click", async () => {
    const user = Number(document.getElementById("recUser").value || "1");
    const topn = Number(document.getElementById("recTopN").value || "10");
    const data = await fetch(`/recs/${user}?top_n=${topn}`).then(r => r.json());
    const root = document.getElementById("recsOutput");
    root.innerHTML = "";
    for (const r of data) {
      const card = document.createElement("div");
      card.className = "p-3 rounded-xl border border-slate-200";
      card.innerHTML = `
        <div class="font-medium">${r.title} <span class="text-xs text-slate-500">${r.year ?? ""}</span></div>
        <div class="text-xs text-slate-500">score ${r.score} · genres: ${r.genres ?? ""}</div>
      `;
      root.appendChild(card);
    }
  });
</script>
